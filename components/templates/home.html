<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Routify ILOILO ‚Äì Jeepney Finder</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style/home.css') }}">

  <!-- üó∫Ô∏è Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

  <style>
    /* Keep your styles */
    body {
      font-family: "Poppins", sans-serif;
      background-color: #f8fbfb;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .nav-container {
      background-color: #cce6e8;
      border-radius: 10px;
      padding: 15px 40px;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .title h1 { margin: 0; color: #004d4d; }
    .links a { margin-left: 15px; text-decoration: none; color: #004d4d; font-weight: bold; }
    .links a:hover { color: #008080; }
    #searchInput {
      width: 300px; padding: 10px; border: 1px solid #aaa;
      border-radius: 8px; outline: none;
    }
    button {
      padding: 10px 15px; background-color: #00a3a3;
      border: none; color: white; font-weight: bold;
      border-radius: 8px; cursor: pointer; margin-left: 8px;
    }
    button:hover { background-color: #007f7f; }
    .jeep-results { margin-top: 25px; }
    .jeep-btn {
      display: block; width: 100%; background-color: #007bff;
      color: white; border: none; border-radius: 8px;
      padding: 12px; margin-bottom: 10px; cursor: pointer;
      text-align: left; transition: background-color 0.2s;
    }
    .jeep-btn:hover { background-color: #0056b3; }
    .footer-text { margin-top: 40px; text-align: center; color: #555; }

    /* üü© Map Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      border-radius: 10px;
      width: 90%; max-width: 800px;
      height: 500px;
      position: relative;
      padding: 10px;
    }
    #map {
      width: 100%; height: 100%;
      border-radius: 10px;
    }
    .close-btn {
      position: absolute; top: 10px; right: 15px;
      background: #ff4d4d; color: white;
      border: none; padding: 5px 10px;
      border-radius: 5px; cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- üß≠ Navbar -->
  <div class="nav-container">
    <div class="title">
      <h1>Routify ILOILO</h1>
    </div>
    <div class="links">
      <a href="{{ url_for('user.home_page') }}">Home</a>
      <a href="{{ url_for('user.route_page') }}">Routes</a>
      <a href="{{ url_for('auth.logout') }}">Logout</a>
    </div>
  </div>

  <!-- üß≠ Search Bar -->
  <h2>Find Jeepneys Going to Your Location</h2>
  <input type="text" id="searchInput" placeholder="Enter location (e.g., Jaro Plaza)">
  <button onclick="searchLocation()">Search</button>

  <!-- üöå Jeep Results -->
  <div class="jeep-results" id="results"></div>

  <!-- ‚ù§Ô∏è Footer -->
  <div class="footer-text">
    <p>Find your way and explore the City of Love ‚Äì Iloilo City üèôÔ∏è</p>
  </div>

  <!-- üó∫Ô∏è Map Modal -->
  <div class="modal" id="mapModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">Close</button>
      <div id="map"></div>
    </div>
  </div>

  <!-- üß† Leaflet Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script>
    let userLat, userLng;
    let map, routingControl;

    // Get user's location
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition((pos) => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
      });
    }

    // üîç Search location and display jeepneys
    async function searchLocation() {
      const query = document.getElementById("searchInput").value.trim();
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "üîé Searching...";

      if (!query) {
        resultsDiv.innerHTML = "<p>Please enter a location first.</p>";
        return;
      }

      try {
        // Get coordinates of searched location
        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const geoData = await geoRes.json();
        if (geoData.length === 0) {
          resultsDiv.innerHTML = "<p>Location not found.</p>";
          return;
        }
        const lat = parseFloat(geoData[0].lat);
        const lng = parseFloat(geoData[0].lon);

        // Fetch jeepneys from backend using lat/lng
        const res = await fetch(`/user/search?lat=${lat}&lng=${lng}`);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          resultsDiv.innerHTML = "<p>No available jeepneys found near this location.</p>";
          return;
        }

        // Display jeepneys as buttons
        resultsDiv.innerHTML = "";
        data.forEach((jeep) => {
          const btn = document.createElement("button");
          btn.className = "jeep-btn";
          btn.innerHTML = `
            <strong>${jeep.jeepney_name}</strong> ‚Äì ${jeep.route}<br>
            Fare: ‚Ç±${jeep.fare} | Distance: ${jeep.distance_km} km
          `;
          btn.onclick = () => openMapModal(lat, lng, jeep);
          resultsDiv.appendChild(btn);
        });
      } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = "<p>‚ö†Ô∏è Error searching for jeepneys.</p>";
      }
    }

    // üó∫Ô∏è Open map modal and show route
    function openMapModal(destLat, destLng, jeep) {
      const modal = document.getElementById("mapModal");
      modal.style.display = "flex";

      // Initialize map if not yet created
      if (!map) {
        map = L.map("map").setView([destLat, destLng], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);
      }

      // Remove previous route
      if (routingControl) map.removeControl(routingControl);

      // Add route from user location to jeepney‚Äôs location (or destination)
      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(userLat, userLng),
          L.latLng(destLat, destLng)
        ],
        routeWhileDragging: true
      }).addTo(map);
    }

    // Close modal
    function closeModal() {
      document.getElementById("mapModal").style.display = "none";
      if (routingControl) map.removeControl(routingControl);
    }
  </script>
</body>
</html>
